{% extends "base.html" %}

{% block left_col %}
<h1 id="main_heading">Modify Appointment</h1>
{% endblock %}

{% block right_col %}
<div class="form-card">
    <form method="POST">
        {{ form.hidden_tag() }}

        <div class="floating-label">
            {{ form.venue(class="form-input") }}
            {{ form.venue.label }}
        </div>

        <div class="floating-label">
            {{ form.date_appoint(class="form-input") }}
            {{ form.date_appoint.label }}
        </div>

        <div class="floating-label">
            {{ form.slot(class="form-input", id="slot") }}
            {{ form.slot.label }}
        </div>

        <div class="floating-label">
            {{ form.provider_id(class="form-input", id="provider_id") }}
            {{ form.provider_id.label }}
        </div>

        <div class="floating-label">
            {{ form.consumer_id(class="form-input") }}
            {{ form.consumer_id.label }}
        </div>

        <div class="floating-label">
            {{ form.service_name(class="form-input") }}
            {{ form.service_name.label }}
        </div>

        <div class="floating-label">
            {{ form.duration.label }}
            {{ form.duration(class="form-input", id="service_duration", min=1) }}
        </div>

        <div class="floating-label">
            {{ form.nber_services.label }}
            {{ form.nber_services(class="form-input", id="nb_services", min=1) }}
        </div>

        <strong>Total Cost: <span id="total-cost">$0.00</span></strong>
        <input type="hidden" id="service_price" name="service_price" value="0.00">


        <div style="margin-top: 20px;">
            {{ form.submit(class="btn-primary", value="Modify appointment") }}
        </div>
    </form>

    <div style="margin-top: 10px;">
        <a href="{{ url_for('bp-admin.view_admin_appointment', appt_id=appt_id) }}" class="btn btn-secondary">Cancel</a>
    </div>
</div>

<script>
    const durationInput = document.getElementById("service_duration");
    const nbServicesInput = document.getElementById("nb_services");
    const providerSelect = document.getElementById("provider_id");
    const slotSelect = document.getElementById("slot");
    const totalOutput = document.getElementById("total-cost");
    const priceField = document.getElementById("service_price");

    function updateTotal() {
        const duration = parseFloat(durationInput.value);
        const selectedOption = providerSelect.options[providerSelect.selectedIndex];
        const payRate = parseFloat(selectedOption?.dataset.payrate) || 15.75;

        if (!isNaN(duration)) {
            const total = (duration * payRate).toFixed(2);
            totalOutput.textContent = `$${total}`;
            priceField.value = total;
        }
    }

    function updateMaxDuration() {
        if (!slotSelect || !durationInput) return;

        const slot = slotSelect.value;
        const [startStr] = slot.split("-");
        const startHour = parseInt(startStr);

        let maxDuration = 1;

        if (startHour >= 1 && startHour < 12) {
            maxDuration = 12 - startHour;
        } else if (startHour >= 13 && startHour < 22) {
            maxDuration = 22 - startHour;
        } else {
            durationInput.max = 0;
            durationInput.value = '';
            durationInput.disabled = true;
            return;
        }

        durationInput.disabled = false;
        durationInput.max = maxDuration;

        const currentDuration = parseInt(durationInput.value) || 1;
        const boundedDuration = Math.min(currentDuration, maxDuration);
        durationInput.value = boundedDuration;

        nbServicesInput.min = 1;
        nbServicesInput.max = boundedDuration;

        // Adjust nb_services if out of bounds
        if (!nbServicesInput.value || parseInt(nbServicesInput.value) < 1) {
            nbServicesInput.value = 1;
        } else if (parseInt(nbServicesInput.value) > boundedDuration) {
            nbServicesInput.value = boundedDuration;
        }

        updateTotal();
    }

    durationInput.addEventListener("input", () => {
        updateMaxDuration();
        updateTotal();
    });

    providerSelect.addEventListener("change", updateTotal);
    slotSelect?.addEventListener("change", () => {
        updateMaxDuration();
        updateTotal();
    });

    window.addEventListener("DOMContentLoaded", () => {
        updateMaxDuration();
        updateTotal();
    });
</script>

{% endblock %}
