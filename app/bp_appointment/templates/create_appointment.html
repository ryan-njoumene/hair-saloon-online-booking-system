
{% extends "base.html" %}

{% block left_col %}
<h1 id="main_heading">Schedule New appointment</h1>
{% endblock %}

{% block right_col %}
<div class="form-card">
    <form method="POST">
        {{ form.hidden_tag() }}

        <div class="floating-label">
            {{ form.venue }}
            {{ form.venue.label }}
        </div>
        
        <div class="floating-label">
            {{ form.date_appoint }}
            {{ form.date_appoint.label }}
        </div>
        
        <div class="floating-label">
            {{ form.slot(id="slot") }}
            {{ form.slot.label }}
        </div>
        
        <div class="floating-label">
            <select name="provider_id" id="provider_id" class="form-control" required>
                <option value="" disabled selected hidden></option>
                {% for value, label in form.provider_id.choices %}
                    <option value="{{ value }}" data-payrate="{{ pay_rates.get(value, 15.75) }}"
                        {% if value == form.provider_id.data %} selected {% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
            <label for="provider_id">Professional</label>            
        </div>
        
        
        
        <div class="floating-label">
            {{ form.service_name }}
            {{ form.service_name.label }}
        </div>
        
        <div class="floating-label">
            {{ form.service_duration(id="service_duration") }}
            {{ form.service_duration.label }}
        </div>
        
        <div class="floating-label">
            {{ form.nb_services(id="nb_services") }}
            {{ form.nb_services.label }}
        </div>
        
        <div style="margin-top: 10px;">
            <strong>Total Cost: <span id="total-cost">$0.00</span></strong>
        </div>
        

        <div>
            {{ form.submit(class="btn-success") }}
        </div>
    </form>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const durationInput = document.getElementById("service_duration");
        const nbServicesInput = document.getElementById("nb_services");
        const providerSelect = document.getElementById("provider_id");
        const slotSelect = document.getElementById("slot");
        const costOutput = document.getElementById("total-cost");
    
        nbServicesInput.value = 1;
    
        function getStartHour(slotValue) {
            const parts = slotValue.split("-");
            return parseInt(parts[0]) || 9;
        }
    
        function updateDurationBounds() {
            const slotValue = slotSelect?.value;
            if (!slotValue) return;
    
            const startHour = getStartHour(slotValue);
            const maxEndHour = startHour < 12 ? 12 : 22;
            const maxDuration = maxEndHour - startHour;
    
            durationInput.min = 1;
            durationInput.max = maxDuration;
    
            let currentDuration = parseInt(durationInput.value) || 1;
            if (currentDuration < 1) currentDuration = 1;
            if (currentDuration > maxDuration) currentDuration = maxDuration;
    
            durationInput.value = currentDuration;
    
            nbServicesInput.max = currentDuration;
            let currentNb = parseInt(nbServicesInput.value) || 1;
            if (currentNb > currentDuration) nbServicesInput.value = currentDuration;
            if (currentNb < 1) nbServicesInput.value = 1;
        }
    
        function updatePrice() {
            const selected = providerSelect.selectedOptions[0];
            const rate = parseFloat(selected?.getAttribute("data-payrate")) || 15.75;
            const duration = parseFloat(durationInput.value) || 0;
            const services = parseInt(nbServicesInput.value) || 1;
            const total = rate * duration;
            costOutput.textContent = `$${total.toFixed(2)}`;
        }
    
        slotSelect.addEventListener("change", () => {
            updateDurationBounds();
            updatePrice();
        });
    
        durationInput.addEventListener("input", () => {
            updateDurationBounds();
            updatePrice();
        });
    
        nbServicesInput.addEventListener("input", updatePrice);
        providerSelect.addEventListener("change", updatePrice);
    
        updateDurationBounds();
        updatePrice();
    });
    </script>
    
{% endblock %}